# 字幕時間軸微調功能 - 完整實現文檔

## 📋 功能概述

字幕時間軸微調功能允許用戶實時調整字幕的顯示時間和播放速度，解決字幕與視頻不同步的問題。此功能已完整整合到 YouTube 視頻播放器中。

## 🎯 核心功能

### 1. 字幕偏移調整 (Subtitle Offset)
- **範圍**: -10秒 到 +10秒
- **精度**: 0.1秒
- **用途**: 修正字幕與視頻的時間差

### 2. 播放速度調整 (Speed Rate)
- **範圍**: 0.8x 到 1.2x
- **精度**: 0.01x
- **用途**: 調整字幕的播放節奏

### 3. 快捷鍵支援
- `Shift + ←` : 字幕提前 0.5秒
- `Shift + →` : 字幕延後 0.5秒
- `Shift + ↑` : 加快字幕速度 0.05x
- `Shift + ↓` : 減慢字幕速度 0.05x
- `Shift + 0` : 重設所有調整

## 🏗️ 技術實現

### 組件結構

#### 1. SubtitleTimingPanel (`subtitle-timing-panel.tsx`)
主要的時間軸調整面板組件，包含：
- 偏移量滑桿和快速按鈕
- 速度調整滑桿和預設按鈕
- 使用說明折疊面板
- 啟用/禁用開關

#### 2. 時間計算邏輯
```typescript
// 反向計算原始時間
const originalTime = (videoTime - timing.offset) * timing.speedRate;

// 查找對應字幕
const currentSubtitle = subtitles.find(sub => 
  originalTime >= sub.start && originalTime <= sub.end
);
```

### 數據結構

```typescript
interface SubtitleTimingControls {
  offset: number;        // -10 到 +10 秒
  speedRate: number;     // 0.8 到 1.2 倍速
  enabled: boolean;      // 是否啟用時間調整
}
```

### 本地存儲
- 使用 `localStorage` 保存用戶的調整設定
- 鍵名: `ytTranslateBot-subtitleTiming`
- 頁面重載後自動恢復設定

## 🎨 UI/UX 設計

### 視覺層級
1. **最小化狀態**: 在播放控制列顯示簡潔按鈕，包含當前調整值的徽章
2. **展開面板**: 固定在右下角的完整控制面板

### 視覺回饋
- 調整值不為預設時，按鈕變色提示
- 即時顯示當前偏移和速度值
- 調試模式下顯示詳細計算資訊

### 響應式設計
- 面板寬度: 384px (w-96)
- 自適應不同螢幕尺寸
- 不遮擋視頻內容

## 📊 調試資訊整合

在調試面板中顯示：
- 當前偏移值
- 速度倍率
- 調整後的實際時間計算
- 原始時間 vs 調整後時間對比

## 🔧 整合點

### 1. VideoPlayer 組件整合
- 狀態管理: `subtitleTiming` state
- 本地存儲同步
- 快捷鍵事件監聽
- 調整後字幕查找邏輯

### 2. 輔助函數
- `getCurrentAdjustedSubtitle()`: 根據調整參數查找當前字幕
- `getAdjustedSubtitleTiming()`: 計算調整後的時間範圍

## 💡 使用場景

### 1. 字幕延遲修正
- YouTube 自動生成字幕的延遲
- 第三方字幕文件的時間軸不匹配

### 2. 語速適配
- 不同語言的說話速度差異
- 配合視頻倍速播放

### 3. 多語言支援
- 快速切換不同語言字幕的時間軸
- 為每種語言保存獨立的調整設定

## ✅ 功能特點

1. **即時生效**: 調整立即反映，無需確認
2. **精確控制**: 支援小數點精度調整
3. **雙重操作**: 滑桿 + 按鈕的操作方式
4. **狀態保存**: 自動保存和恢復設定
5. **視覺指示**: 清晰的當前值顯示
6. **快速重設**: 一鍵恢復預設值

## 🚀 未來優化建議

1. **預設配置**: 為常見的字幕源提供預設調整值
2. **自動檢測**: 使用算法自動檢測最佳同步點
3. **歷史記錄**: 保存每個視頻的調整歷史
4. **雲端同步**: 跨設備同步用戶的調整設定
5. **批量應用**: 將調整應用到整個播放列表

## 📝 測試要點

1. **基本功能測試**
   - 偏移調整是否正確生效
   - 速度調整是否影響字幕顯示
   - 重設功能是否恢復預設值

2. **邊界測試**
   - 最大/最小值限制
   - 極端調整值的表現
   - 快速連續調整的穩定性

3. **交互測試**
   - 快捷鍵響應
   - 滑桿和按鈕的同步
   - 本地存儲的持久化

4. **兼容性測試**
   - 不同瀏覽器的表現
   - 全螢幕模式下的功能
   - 移動設備的觸控操作

## 🎉 實現成果

此功能已完整實現並測試通過，為用戶提供了強大而直觀的字幕同步控制能力，顯著提升了觀看體驗。所有核心功能都已整合到主播放器中，並提供了完善的視覺回饋和使用說明。